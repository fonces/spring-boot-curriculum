# Step 28: Áµ±Âêà„ÉÜ„Çπ„Éà„Å®API „ÉÜ„Çπ„Éà

## üéØ „Åì„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÁõÆÊ®ô

- `@SpringBootTest`„Çí‰Ωø„Å£„ÅüÁµ±Âêà„ÉÜ„Çπ„Éà„ÇíÁêÜËß£„Åô„Çã
- MockMvc„ÅßAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Çí„ÉÜ„Çπ„Éà„Åô„Çã
- TestContainers„Åß„Éá„Éº„Çø„Éô„Éº„Çπ„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åô„Çã
- E2E„ÉÜ„Çπ„Éà„ÅÆÂü∫Á§é„ÇíÂ≠¶„Å∂

**ÊâÄË¶ÅÊôÇÈñì**: Á¥Ñ2ÊôÇÈñì

---

## üìã ‰∫ãÂâçÊ∫ñÂÇô

- Step 27„ÅÆ„É¶„Éã„ÉÉ„Éà„ÉÜ„Çπ„Éà„ÅåÁêÜËß£„Åß„Åç„Å¶„ÅÑ„Çã„Åì„Å®

---

## üöÄ „Çπ„ÉÜ„ÉÉ„Éó1: ControllerÁµ±Âêà„ÉÜ„Çπ„Éà

### 1-1. UserControllerIntegrationTest

**„Éï„Ç°„Ç§„É´„Éë„Çπ**: `src/test/java/com/example/hellospringboot/controller/UserControllerIntegrationTest.java`

```java
package com.example.hellospringboot.controller;

import com.example.hellospringboot.dto.request.UserCreateRequest;
import com.example.hellospringboot.entity.User;
import com.example.hellospringboot.repository.UserRepository;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.transaction.annotation.Transactional;

import static org.hamcrest.Matchers.hasSize;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

/**
 * UserControllerÁµ±Âêà„ÉÜ„Çπ„Éà
 */
@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
@Transactional
@DisplayName("UserController Integration Tests")
class UserControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @Autowired
    private UserRepository userRepository;

    @BeforeEach
    void setUp() {
        userRepository.deleteAll();
    }

    @Test
    @DisplayName("„É¶„Éº„Ç∂„Éº„Çí‰ΩúÊàê„Åß„Åç„Çã„Åì„Å®")
    void testCreateUser() throws Exception {
        // Given
        UserCreateRequest request = UserCreateRequest.builder()
                .name("Test User")
                .email("test@example.com")
                .age(25)
                .build();

        // When & Then
        mockMvc.perform(post("/api/users")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andDo(print())
                .andExpect(status().isCreated())
                .andExpect(jsonPath("$.name").value("Test User"))
                .andExpect(jsonPath("$.email").value("test@example.com"))
                .andExpect(jsonPath("$.age").value(25));
    }

    @Test
    @DisplayName("„Éê„É™„Éá„Éº„Ç∑„Éß„É≥„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ400„ÇíËøî„Åô„Åì„Å®")
    void testCreateUserValidationError() throws Exception {
        // Given - ÁÑ°Âäπ„Å™„É™„ÇØ„Ç®„Çπ„Éà
        UserCreateRequest request = UserCreateRequest.builder()
                .name("")  // Á©∫„ÅÆÂêçÂâç
                .email("invalid-email")  // ÁÑ°Âäπ„Å™„É°„Éº„É´
                .age(-1)  // ÁÑ°Âäπ„Å™Âπ¥ÈΩ¢
                .build();

        // When & Then
        mockMvc.perform(post("/api/users")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andDo(print())
                .andExpect(status().isBadRequest())
                .andExpect(jsonPath("$.errors").exists());
    }

    @Test
    @DisplayName("ÂÖ®„É¶„Éº„Ç∂„Éº„ÇíÂèñÂæó„Åß„Åç„Çã„Åì„Å®")
    void testGetAllUsers() throws Exception {
        // Given
        userRepository.save(User.builder()
                .name("User1")
                .email("user1@example.com")
                .age(20)
                .build());
        userRepository.save(User.builder()
                .name("User2")
                .email("user2@example.com")
                .age(30)
                .build());

        // When & Then
        mockMvc.perform(get("/api/users"))
                .andDo(print())
                .andExpect(status().isOk())
                .andExpect(jsonPath("$", hasSize(2)))
                .andExpect(jsonPath("$[0].name").value("User1"))
                .andExpect(jsonPath("$[1].name").value("User2"));
    }

    @Test
    @DisplayName("ID„Åß„É¶„Éº„Ç∂„Éº„ÇíÂèñÂæó„Åß„Åç„Çã„Åì„Å®")
    void testGetUserById() throws Exception {
        // Given
        User user = userRepository.save(User.builder()
                .name("Test User")
                .email("test@example.com")
                .age(25)
                .build());

        // When & Then
        mockMvc.perform(get("/api/users/{id}", user.getId()))
                .andDo(print())
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.id").value(user.getId()))
                .andExpect(jsonPath("$.name").value("Test User"));
    }

    @Test
    @DisplayName("Â≠òÂú®„Åó„Å™„ÅÑID„ÅÆÂ†¥Âêà„ÅØ404„ÇíËøî„Åô„Åì„Å®")
    void testGetUserByIdNotFound() throws Exception {
        // When & Then
        mockMvc.perform(get("/api/users/999"))
                .andDo(print())
                .andExpect(status().isNotFound());
    }

    @Test
    @DisplayName("„É¶„Éº„Ç∂„Éº„ÇíÊõ¥Êñ∞„Åß„Åç„Çã„Åì„Å®")
    void testUpdateUser() throws Exception {
        // Given
        User user = userRepository.save(User.builder()
                .name("Old Name")
                .email("old@example.com")
                .age(20)
                .build());

        UserCreateRequest updateRequest = UserCreateRequest.builder()
                .name("New Name")
                .email("new@example.com")
                .age(30)
                .build();

        // When & Then
        mockMvc.perform(put("/api/users/{id}", user.getId())
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(updateRequest)))
                .andDo(print())
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.name").value("New Name"))
                .andExpect(jsonPath("$.email").value("new@example.com"))
                .andExpect(jsonPath("$.age").value(30));
    }

    @Test
    @DisplayName("„É¶„Éº„Ç∂„Éº„ÇíÂâäÈô§„Åß„Åç„Çã„Åì„Å®")
    void testDeleteUser() throws Exception {
        // Given
        User user = userRepository.save(User.builder()
                .name("Test User")
                .email("test@example.com")
                .age(25)
                .build());

        // When & Then
        mockMvc.perform(delete("/api/users/{id}", user.getId()))
                .andDo(print())
                .andExpect(status().isNoContent());
    }
}
```

---

## üöÄ „Çπ„ÉÜ„ÉÉ„Éó2: „ÉÜ„Çπ„ÉàÁî®Ë®≠ÂÆö„Éï„Ç°„Ç§„É´

### 2-1. application-test.yml

**„Éï„Ç°„Ç§„É´„Éë„Çπ**: `src/test/resources/application-test.yml`

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/hello_db_test?useSSL=false&serverTimezone=Asia/Tokyo
    username: appuser
    password: apppassword
    driver-class-name: com.mysql.cj.jdbc.Driver

  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MySQLDialect

logging:
  level:
    com.example.hellospringboot: DEBUG
    org.springframework.test: INFO
```

> **üí° „Éí„É≥„Éà**: „ÉÜ„Çπ„ÉàÁî®„Å´Âà•„ÅÆ„Éá„Éº„Çø„Éô„Éº„ÇπÔºà`hello_db_test`Ôºâ„Çí‰ΩøÁî®„Åô„Çã„Åì„Å®„Åß„ÄÅÊú¨Áï™„Éá„Éº„Çø„Å®ÂàÜÈõ¢„Åß„Åç„Åæ„Åô„ÄÇ„ÉÜ„Çπ„ÉàÂâç„Å´‰ª•‰∏ã„ÅÆ„Ç≥„Éû„É≥„Éâ„Åß„ÉÜ„Çπ„ÉàÁî®DB„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
> ```sql
> CREATE DATABASE IF NOT EXISTS hello_db_test;
> ```

---

## üöÄ „Çπ„ÉÜ„ÉÉ„Éó3: Ë™çË®º‰ªò„ÅçAPI„ÉÜ„Çπ„Éà

### 3-1. AuthControllerIntegrationTest

**„Éï„Ç°„Ç§„É´„Éë„Çπ**: `src/test/java/com/example/hellospringboot/controller/AuthControllerIntegrationTest.java`

```java
package com.example.hellospringboot.controller;

import com.example.hellospringboot.dto.request.LoginRequest;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.web.servlet.MockMvc;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
@DisplayName("AuthController Integration Tests")
class AuthControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @Test
    @DisplayName("Ê≠£„Åó„ÅÑË™çË®ºÊÉÖÂ†±„Åß„É≠„Ç∞„Ç§„É≥„Åß„Åç„Çã„Åì„Å®")
    void testLoginSuccess() throws Exception {
        // Given
        LoginRequest request = LoginRequest.builder()
                .username("user")
                .password("user123")
                .build();

        // When & Then
        mockMvc.perform(post("/api/auth/login")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andDo(print())
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.token").exists())
                .andExpect(jsonPath("$.type").value("Bearer"))
                .andExpect(jsonPath("$.username").value("user"));
    }

    @Test
    @DisplayName("Ë™§„Å£„ÅüË™çË®ºÊÉÖÂ†±„ÅÆÂ†¥Âêà„ÅØ401„ÇíËøî„Åô„Åì„Å®")
    void testLoginFailure() throws Exception {
        // Given
        LoginRequest request = LoginRequest.builder()
                .username("user")
                .password("wrongpassword")
                .build();

        // When & Then
        mockMvc.perform(post("/api/auth/login")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andDo(print())
                .andExpect(status().isUnauthorized());
    }
}
```

---

## üöÄ „Çπ„ÉÜ„ÉÉ„Éó4: „ÉÜ„Çπ„ÉàÂÆüË°å„Å®„É¨„Éù„Éº„Éà

### 4-1. „Åô„Åπ„Å¶„ÅÆ„ÉÜ„Çπ„Éà„ÇíÂÆüË°å

```bash
./mvnw clean test
```

### 4-2. ÁâπÂÆö„ÅÆ„ÉÜ„Çπ„Éà„ÇØ„É©„Çπ„ÅÆ„ÅøÂÆüË°å

```bash
./mvnw test -Dtest=UserControllerIntegrationTest
```

### 4-3. „Ç´„Éê„É¨„ÉÉ„Ç∏„É¨„Éù„Éº„ÉàÁ¢∫Ë™ç

```bash
./mvnw clean test jacoco:report
open target/site/jacoco/index.html
```

---

## üé® „ÉÅ„É£„É¨„É≥„Ç∏Ë™≤È°å

### „ÉÅ„É£„É¨„É≥„Ç∏ 1: PostControllerÁµ±Âêà„ÉÜ„Çπ„Éà

PostController„ÅÆÁµ±Âêà„ÉÜ„Çπ„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

### „ÉÅ„É£„É¨„É≥„Ç∏ 2: TestContainers„ÅÆÂ∞éÂÖ•

Êú¨Áâ©„ÅÆMySQL„Çí‰Ωø„Å£„Åü„ÉÜ„Çπ„Éà„ÇíÂÆüË£Ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

```xml
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>mysql</artifactId>
    <version>1.19.3</version>
    <scope>test</scope>
</dependency>
```

### „ÉÅ„É£„É¨„É≥„Ç∏ 3: REST Assured„ÅÆ‰ΩøÁî®

REST Assured„É©„Ç§„Éñ„É©„É™„Çí‰Ωø„Å£„Åü„ÉÜ„Çπ„Éà„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

## üìö „Åì„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅßÂ≠¶„Çì„Å†„Åì„Å®

- ‚úÖ @SpringBootTest„Å´„Çà„ÇãÁµ±Âêà„ÉÜ„Çπ„Éà
- ‚úÖ MockMvc„Å´„Çà„ÇãAPI„ÉÜ„Çπ„Éà
- ‚úÖ JSON„Éë„Çπ„Ç¢„Çµ„Éº„Ç∑„Éß„É≥
- ‚úÖ „ÉÜ„Çπ„ÉàÁî®Ë®≠ÂÆö„Éï„Ç°„Ç§„É´
- ‚úÖ „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„É≠„Éº„É´„Éê„ÉÉ„ÇØ

---

## üîÑ Git„Å∏„ÅÆ„Ç≥„Éü„ÉÉ„Éà„Å®„É¨„Éì„É•„Éº‰æùÈ†º

```bash
git add .
git commit -m "Step 28: Áµ±Âêà„ÉÜ„Çπ„ÉàÂÆå‰∫Ü"
git push origin main
```

„Ç≥„Éü„ÉÉ„ÉàÂæå„ÄÅ**Slack„Åß„É¨„Éì„É•„Éº‰æùÈ†º**„ÇíÂá∫„Åó„Å¶„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Çí„ÇÇ„Çâ„ÅÑ„Åæ„Åó„Çá„ÅÜÔºÅ

---

## ‚û°Ô∏è Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó

Ê¨°„ÅØ[Step 29: „ÉÜ„Çπ„Éà„Ç´„Éê„É¨„ÉÉ„Ç∏](STEP_29.md)„Å∏ÈÄ≤„Åø„Åæ„Åó„Çá„ÅÜÔºÅ

JaCoCo„Çí‰Ωø„Å£„Å¶„ÉÜ„Çπ„Éà„ÅÆÁ∂≤ÁæÖÊÄß„ÇíÁ¢∫Ë™ç„Åó„ÄÅÂìÅË≥™„ÇíÂêë‰∏ä„Åï„Åõ„Åæ„Åô„ÄÇ

---

„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„ÅüÔºÅ üéâ

Áµ±Âêà„ÉÜ„Çπ„Éà„ÇíÁøíÂæó„Åó„Åæ„Åó„ÅüÔºÅÂÆüÈöõ„ÅÆHTTP„É™„ÇØ„Ç®„Çπ„Éà„Çí„ÉÜ„Çπ„Éà„Åô„ÇãÊñπÊ≥ï„Åå
